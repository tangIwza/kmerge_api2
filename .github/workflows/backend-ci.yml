# .github/workflows/backend-ci.yml

name: Backend CI/CD

on:
  # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ push ‡πÑ‡∏õ‡∏¢‡∏±‡∏á branch 'main'
  push:
    branches: [ "main" ]
  # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î Pull Request ‡∏°‡∏≤‡∏¢‡∏±‡∏á branch 'main'
  pull_request:
    branches: [ "main" ]

jobs:
  # ----------------------------------------------
  # Job 1: CI (Continuous Integration)
  # ----------------------------------------------
  ci:
    name: Run Linter and Tests
    runs-on: ubuntu-latest # ‡πÉ‡∏ä‡πâ OS ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å repo

      - name: Setup Node.js v18
        uses: actions/setup-node@v4 # ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Node.js
        with:
          node-version: '18'
          cache: 'npm' # ‡∏™‡∏±‡πà‡∏á cache 'npm' dependencies

      - name: Install dependencies
        run: npm ci # ‡πÉ‡∏ä‡πâ npm ci ‡∏à‡∏∞‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ npm install ‡πÅ‡∏•‡∏∞‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° package-lock.json

      - name: Run linter
        run: npm run lint # ‡∏£‡∏±‡∏ô linter ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô package.json

      - name: Run tests
        run: npm run test # ‡∏£‡∏±‡∏ô tests ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô package.json
        env:
          # ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Secrets ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô GitHub
          # ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡∏™‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Supabase (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏™)
          SUPABASE_URL: ${{ secrets.SUPABASE_URL_TEST }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY_TEST }}

  # ----------------------------------------------
  # Job 2: CD (Continuous Deployment)
  # ----------------------------------------------
  cd:
    name: Build and Deploy to Production
    needs: ci # ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÉ‡∏´‡πâ job 'ci' ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    runs-on: ubuntu-latest
    
    # ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô event 'push' ‡πÑ‡∏õ‡∏¢‡∏±‡∏á 'main' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js v18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build # ‡∏£‡∏±‡∏ô build script ‡∏à‡∏≤‡∏Å package.json
        env:
          NODE_ENV: production # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ environment ‡πÄ‡∏õ‡πá‡∏ô production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4 # ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà build ‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå dist)
        with:
          name: production-build
          path: | # ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå/‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
            dist
            node_modules
            package.json
            package-lock.json
      
      # --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Deploy ---
      # ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Render, Heroku, etc.)
      - name: üöÄ Deploy to Production (Placeholder)
        run: echo "Build complete. Add your deployment script here."

      # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ Render.com ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ Deploy Hook
      # - name: Trigger Render Deploy
      #   run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
